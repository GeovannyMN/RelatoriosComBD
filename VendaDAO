package br.com.gnovais;

import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Time;
import java.sql.Timestamp;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;

public class VendaDAO {

    public void salvar(Venda venda) throws SQLException{

        var sql = "insert into venda (valor, formadepagamento, hora) values (?, ?, ?)";

        try (var conexao = Conexao.obterConexao();
             var stmt = conexao.prepareStatement(sql)){

            stmt.setFloat(1, venda.valor());
            stmt.setString(2, venda.formaDePagamento());
            
            Time horaConvertida = new Time(venda.hora().getTime());
            stmt.setTime(3, horaConvertida);

            stmt.executeUpdate();
        } catch (SQLException e) {
            throw new SQLException(e);
        }
    }

    public List<Venda> buscarPorTodasVendas() throws SQLException{
        List<Venda> vendas = new ArrayList<>();

        var sql = "select * from minhasvendas.venda";

        try (var conexao = Conexao.obterConexao();
             var stmt = conexao.prepareStatement(sql)){

                try(ResultSet rs = stmt.executeQuery()){
                    while(rs.next()){
                        SimpleDateFormat sdf = new SimpleDateFormat("HH:mm:ss");
                        Time horaTime = rs.getTime("hora");
                        Date horaData;
                        try {

                            horaData = sdf.parse(horaTime.toString());
                            Timestamp horaTimestamp = new Timestamp(horaData.getTime());
                            Venda venda = new Venda(rs.getInt("id"),
                            rs.getFloat("valor"),
                            rs.getString("formaDePagamento"), 
                            horaTimestamp );

                            vendas.add(venda);
                        } catch (ParseException e) {
                            System.out.println("Não foi possível converter a hora corretamente!");
                        }
                    }
                }            
        } catch (SQLException e) {
            throw new SQLException(e);
        }

        return vendas;
    }
}
